# Bug Fix Journal - Issue #5: Uninitialized Variable in ScaleToFit()

**Date**: 2026-02-15  
**Issue**: #5 from docs/plan.md  
**File**: `pho.c:318-377`  
**Type**: Logic error / Uninitialized variable

## Problem Description

In `ScaleToFit()` function, when using `PHO_SCALE_SCREEN_RATIO` mode, if the image already fit within the maximum dimensions (both xratio and yratio <= 1), the variables `new_w` and `new_h` were never initialized. They contained garbage values that were then used to set the output dimensions.

## Root Cause

```c
if (scaleMode == PHO_SCALE_SCREEN_RATIO) {
    double xratio = (double)(*width) / max_width;
    double yratio = (double)(*height) / max_height;

    if (xratio > 1. || yratio > 1.) {    /* need some scaling */
        // initializes new_w, new_h
    }
    // NO ELSE CLAUSE - new_w and new_h uninitialized if no scaling needed
}
```

## Fix Applied

Added an `else` clause to handle the case when no scaling is needed:

```c
if (xratio > 1. || yratio > 1.) {    /* need some scaling */
    if (xratio > yratio) {  /* X needs more scaling down */
        new_w = *width / xratio;
        new_h = *height / xratio;
    } else {                /* Y needs more scaling down */
        new_w = *width / yratio;
        new_h = *height / yratio;
    }
} else {
    /* No scaling needed - preserve original dimensions */
    new_w = *width;
    new_h = *height;
}
```

## Testing

### Regression Test Results
```
$ ./regression/test_issue_5

test_scale_to_fit_no_scaling_needed_screen_ratio:PASS
test_scale_to_fit_exact_fit_screen_ratio:PASS
test_scale_to_fit_slightly_smaller_screen_ratio:PASS
test_scale_to_fit_with_ratio_scale:PASS
test_scale_to_fit_multiple_calls:PASS

5 Tests 0 Failures 0 Ignored - OK
```

### Test Coverage
- No scaling needed (image already fits)
- Exact fit (image matches max dimensions)
- Slightly smaller than max dimensions
- With scale ratio applied
- Multiple calls produce consistent results

## Verification

1. ✅ All regression tests pass
2. ✅ Main binary compiles without errors
3. ✅ Fix is minimal and targeted
4. ✅ No side effects on other scale modes

## Impact

- **Before Fix**: Random garbage values used for image dimensions when no scaling needed
- **After Fix**: Original dimensions correctly preserved

## Lessons Learned

1. Always initialize variables before use
2. Have an else clause for every if that initializes variables
3. Regression tests catch bugs and verify fixes
4. Testing infrastructure investment pays off immediately
